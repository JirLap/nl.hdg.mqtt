<link rel="stylesheet" type="text/css" href="../../../assets/styles.css" />
<link rel="stylesheet" type="text/css" href="./discover.css" />
<script src='../../../assets/vue.min.js'></script>
<script src='../../../assets/lodash.min.js'></script>
<script src='../../../assets/utils.js'></script>
<script>
    Homey.setTitle(__('pair.title.discovery'));

    let HASS_ICON = '../assets/icon.svg';
    let DEFAULT_CONFIG = {};

    new Vue({
        el: '#hass_discovery',
        data: {
            CAPABILITIES: {},
            lang: 'en', // TODO: multi lang
            searching: true,
            deviceClasses: [],
            capabilities: [],
            haDevice: undefined,
            devices: undefined,
        },
        methods: {
            initCapabilities(result) {
                this.CAPABILITIES = result;
                this.capabilities = Object.keys(result)
                    .sort((a, b) => sortByTitle(result[a], result[b], this.lang))
                    .map(id => result[id]);
            },
            initDeviceClasses(result) {
                this.deviceClasses = Object.keys(result)
                    .sort((a, b) => sortByTitle(result[a], result[b], this.lang))
                    .map(id => result[id]);
            },
            onDevice(device) {
                console.log(device);
                if (!this.devices) {
                    this.devices = {};
                }
                if (device && device.id && device.name) {

                    let config = this.devices[device.id];
                    if(config) {
                        // custom device name?
                        device.deviceName = config.deviceName || device.name;

                        // custom device class?
                        if (config.deviceClass) {
                            device.deviceClass = config.deviceClass;
                        }

                        // custom icon
                        if (!config.icon) {
                            device.icon = config.icon;
                        }

                        // pre-selected capabilities
                        if (device.properties) {
                            for (let property of device.properties) {
                                const configProp = config.properties ? config.properties.find(p => p.id == property.id) : undefined;
                                property.capabilityId = configProp ? configProp.capabilityId : (property.capabilityId || property.capability);
                                property.displayName = configProp ? configProp.displayName : (property.displayName || property.name);
                            }
                        }
                    } else {
                        // custom device name?
                        device.deviceName = device.deviceName || device.name;

                        // parse capabilities
                        if (device.properties) {
                            for (let property of device.properties) {
                                property.capabilityId = property.capabilityId || property.capability;
                                property.displayName = property.displayName || property.name;
                            }
                        }
                    }

                    // display (updated) device 
                    Vue.set(this.devices, device.id, device);
                }
            },
            onDeviceClick(node) {
                Vue.set(node, 'open', !node.open);
            },
            createDevice(node) {
                Homey.emit('create', node, (err, result) => {
                    if (!err) {
                        Homey.createDevice(result, (err, result) => {
                            if (!err) {
                                Vue.set(node, 'created', true);
                                Vue.set(node, 'open', false);
                                //Homey.alert(Homey.__('pair.ha_discovery.success'));
                            } else {
                                Homey.alert(Homey.__('pair.ha_discovery.failure'));
                            }
                        });
                    } else {
                        Homey.alert(Homey.__('pair.ha_discovery.failure'));
                    }
                });
            },
            unit(capability, expandEnum) {
                if(capability.units && capability.units[this.lang]) return capability.units[this.lang];
                switch(capability.type) {
                    case 'string': return 'text';
                    case 'boolean': return 'true | false';
                    case 'enum': return expandEnum ? capability.values.map(v => v.id).join(' | ') : 'enum';
                    default: return capability.type;
                }
            },
            showDisplayName(property) {
                return true;
                //return property && ['measere_text', 'measure_numeric', 'measure_binary'].includes(property.capabilityId);
            },
            getPlaceholder(property) {
                if(property.capabilityId) {
                    let capability = this.CAPABILITIES[property.capabilityId];
                    if(capability) {
                        return capability.title[this.lang];
                    }
                }
                return '';
            }
        },
        watch: {
        },
        mounted() {
            Homey.emit('capabilities', null, (err, result) => this.initCapabilities(result));
            Homey.emit('deviceClasses', null, (err, result) => this.initDeviceClasses(result));
            Homey.on('detected', device => this.haDevice = device);
            Homey.on('device', this.onDevice.bind(this));
            Homey.on('done', () => this.searching = false);
        }
    });
</script>

<div id="hass_discovery">

    <div v-if="!devices && !haDevice" class="waiting">
        <p>{{__('pair.ha_discovery.waiting')}}</p>
    </div>

    <div v-if="haDevice" class="homie-device settings">
        <span>{{__('pair.ha_discovery.found')}}: <b>{{haDevice}}</b></span>
    </div>
    <div v-if="devices" class="devices settings">
        <p>{{__('pair.ha_discovery.discovered')}}</p>
        <div class="homie-node" v-for="(node, nodeId) in devices" v-bind:class="{ created: node.created, open:node.open }">

            <div class="device-header" @click="onDeviceClick(node)">
                <i class="fa chevron" v-bind:class="{ 'fa-chevron-down': !node.open, 'fa-chevron-up': node.open}"></i>
                <img class="device-icon" :src="node.icon" />
                <div class="device-header-text">
                    <div><b>{{node.name}}</b></div>
                    <div>{{(node.type || node.deviceClass || '').replace('_', ' ')}}</div>
                </div>
            </div>
            <div class="capabilities" v-if="node.open">
                <div class="setting">
                    <label class="settings-item-description">{{__('pair.select.name')}}</label>
                    <div class="settings-itemgroup">
                        <input type="text" v-model="node.deviceName">
                    </div>
                </div>
                <div class="setting">
                    <label class="settings-item-description">{{__('pair.select.class')}}</label>
                    <div class="settings-itemgroup">
                        <select v-model="node.deviceClass">
                            <option :value="item.id" v-for="item of deviceClasses">
                                {{item.title[lang]}}
                            </option>
                        </select>
                    </div>
                </div>
                <!-- <h2 class="capabilities-header" v-if="node.properties && node.properties.length">PROPERTIES</h2> -->
                <div class="capability" v-for="property in node.properties">
                    <h3 class="capabilities-header">{{property.name}}</h3>
                    <div class="setting">
                        <label class="settings-item-description">{{__('pair.ha_discovery.capability')}}<span v-if=property.unit> ({{property.unit}})</span></label>
                        <div class="settings-itemgroup">
                            <select v-model="property.capabilityId">
                                <option value="">{{__('pair.ha_discovery.selectCapability')}}</option>
                                <option :value="item.id" v-for="item of capabilities">
                                    {{item.title[lang] + (item.id ? ` (${ unit(item)})` : '')}}
                                </option>
                            </select>
                            
                        </div>
                    </div>
                    <div class="setting" v-if="showDisplayName(property)">
                        <label class="settings-item-property-displayname">{{__('pair.ha_discovery.propertyName')}}</label>
                        <div class="settings-itemgroup">
                            <input type="text" v-model="property.displayName" :placeholder="getPlaceholder(property)">
                        </div>
                    </div>
                </div>
                <button class="hy-button visible create-button" @click="createDevice(node)">
                    <i class="fa fa-plus"></i>&nbsp;
                    <span>{{__('pair.ha_discovery.add')}}</span>
                </button>
            </div>
        </div>
    </div>
    <div class="loader" v-if="searching">
        <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
            <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946 s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634 c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
            <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0 C22.32,8.481,24.301,9.057,26.013,10.047z">
                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="0.5s" repeatCount="indefinite" />
            </path>
        </svg>
    </div>
    
</div>
