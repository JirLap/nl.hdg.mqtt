=== TODO ===

- [BUG] enabling virtual devices breaks the hub
- Check client availability processing
- HASS Discovery
- profile client & hub
- display broadcast progress (loader)
- Enable/disable all devices
- fix system info topic
- fix non-awaited promises
- optional normalization for custom protocol
- Send empty (non-retained) message to clear device (fixed with restore of homeyProperty retain = null after send?)
- Publish device/$state disconnect message
- Support virtual button?
- implement scalable property 0-1 (float) | 0-100 (int)
- Flow card for MQTT Device
- Create virtual devices from MQTT discovery
- Catch Renaming zones / devices
- Check: dispatched firmWare version
- Setting to enable/disable set command handler
- [Check] Refresh devices on device/zone changes + Broadcast
- Info requests:
  * System
  * Device classes
  * Zones
- Updating state for multiple devices (e.g. all devices in a room)
- Publish system info on seperate topics (i.s.o. json)
- Trigger flow command
- Listen to scene flow triggers
- Uninstall app => unsubscribe from topics
- test internal MQTT client ('socket hang up' fix? duplicate mem usage, config & maintenance...)

[cannot reproduce]
- some $set commands don't work (openHab/broker/client/hub config/restart/updates??)
- all devices are shown off @ first load

[DEPRECATED]
- Update value parsing (based on capability description)
- implement remaining destroy methods
- enable setting for deprecated protocol / clean-up old code


======= DONE =======
- Normalize device name
- Fix getDeviceName for homey 1.5.13
- MQTT discovery (see OpenHAB / Domiticz)
- Implement Homie convention (Homey v1.5.13)
- Homie Convention for Homey v2.0
- Normalization BUG
- Handle device & zone name changes in HomieDispatcher
- Try to combine the old topic format with the Homie Convention (&Ditch the old topic format?)
- Fix on/off button
- Disable settings running button (show loader) untill state active state is received
- Settings page
	* Select communication protocol (Homie | Homey)
	* Homie color format (HSV | RGB)
	* Configure root topic
	* Configure Homie topic
	* Enable/disable system state dispatcher
	* Enable/Disable triggers & commands
	* Include/Exclude devices & capabilities for dispatchers
	* refresh/resend state
	* Inject device id
	* Update settings on save
	* Display current status
	* Log stream
- Rename to 'MQTT Hub'
- Fix app icon
- App images
- BUG: Initial settings (root topic undefined)
- BUG: Normalize injected device class & zone
- Custom protocal & disable non-protocol options
- Activate & update command + rename to 'set'
- Settings Instructions tab

=== Unhandled exceptions ===

??????????????? Logging stdout & stderr ???????????????
/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/manager/settings.js:1
(function (exports, require, module, __filename, __dirname) { "use strict";const fs=require("fs"),path=require("path"),Homey=require("homey");class ManagerSettings extends Homey.Manager{__onInit(){this._updateSettingsTimeout=void 0,this._writing=!1,this.__client.emitSystem("getSettings").then(t=>{this._settings=t,this.__ready()}).catch(t=>{this.error(t),this._settings={},this._updateSettings(),this.__ready()}),this.__client.on("settings.get",this._onSettingsGet.bind(this)),this.__client.on("settings.set",this._onSettingsSet.bind(this)),this.__client.on("settings.unset",this._onSettingsUnset.bind(this))}_onSettingsGet(t,e){return!1===t.name?e(null,this._settings):e(null,this.get(t.name))}_onSettingsSet(t,e){try{return this.set(t.name,t.value),e(null,this.get(t.name))}catch(t){return e(t)}}_onSettingsUnset(t,e){try{return this.unset(t.name,t.value),e(null)}catch(t){return e(t)}}getKeys(){return Object.keys(this._settings)}get(

TypeError: Cannot read property 'settings' of undefined
    at ManagerSettings.get (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/manager/settings.js:1:1060)
    at ManagerSettings._onSettingsGet (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/manager/settings.js:1:684)
    at _eventListeners.filter.forEach.t (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1220)
    at Array.forEach (<anonymous>)
    at HomeyClient._onMessage (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1197)
    at emitTwo (events.js:126:13)
    at process.emit (events.js:214:7)
    at emit (internal/child_process.js:762:12)
    at _combinedTickCallback (internal/process/next_tick.js:142:11)
    at process._tickCallback (internal/process/next_tick.js:181:9)

--- INFO: nl.hdg.mqtt has been killed ---
???????????????????????????????????????????????????????


Failed to update capability value
Notification added
{ request_timeout: Er is een onbekende fout opgetreden [request_timeout]
    at /node_modules/athom-api/dist/index.js:1:1045125
    at <anonymous>
    at process._tickCallback (internal/process/next_tick.js:189:7)
  name: 'request_timeout',
  code: 500,
  cause:
   t {
     __athom_api_type: 'HomeyAPI.ManagerDevices.Error',
     code: 500,
     error: 'request_timeout',
     error_description: 'Er is een onbekende fout opgetreden [request_timeout]',
     '$stack': undefined } }

???????????????????????????????????????????????????????


{ Error: request to http://localhost:80/api/app/nl.scanno.mqtt/subscribe failed, reason: socket hang up
    at Object.JSON.parse (/opt/homey-client/system/helpers/jsonfns.js:1:1190)
    at JSON.parse (<anonymous>)
    at jsonToObject (/opt/homey-client/system/helpers/jsonfns.js:1:1083)
    at function.e.data.map.e (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1379)
    at Array.map (<anonymous>)
    at HomeyClient._onMessage (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1372)
    at emitTwo (events.js:126:13)
    at process.emit (events.js:214:7)
    at emit (internal/child_process.js:762:12)
    at _combinedTickCallback (internal/process/next_tick.js:142:11)
  message: 'request to http://localhost:80/api/app/nl.scanno.mqtt/subscribe failed, reason: socket hang up',
  code: 'ECONNRESET' }

???????????????????????????????????????????????????????


- Handle Socket hang up exceptions:
{ Error: socket hang up
    at Object.<anonymous> (/opt/homey-client/system/manager/ManagerApps/jsonfns.js:1:1103)
    at JSON.parse (<anonymous>)
    at Object.jsonToObject (/opt/homey-client/system/manager/ManagerApps/jsonfns.js:1:1001)
    at function.e.apply.s.args.map.s (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1401)
    at Array.map (<anonymous>)
    at HomeyClient._onMessage (/opt/homey-client/system/manager/ManagerApps/bootstrap/sdk/v2/lib/HomeyClient.js:1:1386)
    at emitTwo (events.js:126:13)
    at process.emit (events.js:214:7)
    at emit (internal/child_process.js:762:12)
    at _combinedTickCallback (internal/process/next_tick.js:142:11) message: 'socket hang up', code: 'ECONNRESET' }